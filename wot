#!/bin/bash
# wot - permite generar una wot en una organización
#
# © 2016 fauno <fauno@partidopirata.com.ar>
#
# Copying and distribution of this file, with or without modification,
# are permitted in any medium without royalty provided the copyright
# notice and this notice are preserved.  This file is offered as-is,
# without any warranty.
# 
# http://www.gnu.org/prep/maintain/html_node/License-Notices-for-Other-Files.html
set -e
set -E

domain="${2:-partidopirata.com.ar}"
wot="${domain}.wot.asc"
methods=()
helps=()

# Chequea que no estamos sourceando
function es_init() {
  test 'xwot' = "x$(basename -- "$0")"
}

# Registra métodos permitidos
function registrar() {
  local _method="${1}"; shift
  methods+=(${_method})
  helps+=("${_method}:${@};")
}

# Ayuda
function help() {
  echo 'wot!'
  echo "genera una red de confianza entre todas las cuentas de ${domain}"
  echo
  echo 'uso:'
  echo ${helps[@]} \
  | tr ';' "\n" \
  | sed -re 's/^\s+//' -e 's/\s+$//' \
  | column -s : -o ' - ' -t
}
registrar help 'esta ayuda'


# TODO: implementar :P
function listar() {
  :
}
registrar listar 'no implementado'

# Exporta todas las llaves a un archivo WOT
function exportar() {
  gpg --export --armor "@${domain}" >"${wot}"
}
registrar exportar "crea un archivo ${wot} para compartir"

# Importa el archivo de WOT
function importar() {
  gpg --import "${wot}"
}
registrar importar "importa ${wot} desde este directorio"

# Trae todas las llaves de la WOT y las firmas
function firmar() {
  gpg --fingerprint "@${domain}" \
	| grep = \
  | cut -d = -f2 \
  | tr -d " " \
  | xargs -rn1 gpg --sign-key
}
registrar firmar 'firma todas las llaves'

function graficar() {
  local _path="$(dirname -- "$0")"
  local _dot="${wot%.asc}.dot"
  local _png="${wot%.asc}.png"

  gpg --list-sigs "@${domain}" \
  | "${_path}/sig2dot" >"${_dot}" 2>/dev/null

  circo -Tpng "${_dot}" >"${_png}"
}
registrar graficar "genera un grafico ${wot%.asc}.png"

# Ejecuta el comando que llamamos
function init() {
  # Valida que estemos llamando a un metodo que exista :P
  echo "${methods[@]}" | grep -qw "${1}" || exit 1
  ${1}
}

# Solo ejecuta la función de inicio si estamos ejecutando el script,
# no si lo estamos importando desde otro.
es_init && init ${1:-help}
